<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Deutschland Umfragen – Dark Mode</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body { 
  margin:0;
  font-family:Inter,sans-serif;
  background:#121212;
  color:#e0e0e0;
  position:relative;
  overflow-x:hidden;
}
body::before {
  content:"";
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background-image:url('reichstag.png');
  background-size:cover;
  background-position:center;
  filter:blur(8px) brightness(0.3);
  z-index:-1;
}
h1 { text-align:center;padding:1rem;margin-bottom:0.5rem }
.newest-poll-date { text-align:center;color:#999;font-size:14px;margin-bottom:1.5rem }
.new-badge { display:inline-block;background:#4f7a5a;color:#fff;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600;margin-top:10px }
.bundestag-section { max-width:1400px;margin:0 auto 2rem;padding:0 2rem }
.bundestag-container { background:#1e1e1e;border-radius:16px;padding:1.5rem;position:relative;overflow:hidden;border:2px solid transparent }
.bundestag-container::before { content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:400px;height:400px;background-image:url('https://upload.wikimedia.org/wikipedia/commons/thumb/d/da/Coat_of_arms_of_Germany.svg/960px-Coat_of_arms_of_Germany.svg.png');background-size:contain;background-repeat:no-repeat;background-position:center;opacity:0.08;pointer-events:none;z-index:0 }
.bundestag-container h2 { margin:0 0 0.5rem 0;font-size:18px;position:relative;z-index:1 }
.bundestag-container .date { color:#999;font-size:14px;margin-bottom:1rem;position:relative;z-index:1 }
.bundestag-container .badge-container { position:relative;z-index:1;margin-top:1rem;text-align:center }
.main { display:flex;max-width:1400px;margin:auto;gap:2rem }
.states { display:grid;grid-template-columns:repeat(4,1fr);gap:1.5rem;padding:2rem;width:50% }
.state { background:#1e1e1e;border-radius:16px;padding:1rem;text-align:center;cursor:pointer;transition:all 0.3s ease;border:2px solid transparent;position:relative;display:flex;flex-direction:column;min-height:140px }
.state:hover { background:#2a2a2a;transform:translateY(-2px) }
.state.active { background:#2d2d2d;border:2px solid #4f7fa8 }
.state-content { flex:1;display:flex;flex-direction:column;justify-content:center }
.state img { width:70px;height:70px;object-fit:contain;margin:auto;display:block }
.state-name { margin-top:0.5rem;font-size:14px;font-weight:600 }
.state .badge-container { margin-top:auto;padding-top:0.5rem }
.panel { width:50%;padding:2rem;background:#181818;position:relative;overflow:hidden }
.panel::before { content:"";position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:400px;height:400px;background-image:var(--bg-coat);background-size:contain;background-repeat:no-repeat;background-position:center;opacity:0.08;pointer-events:none;transition:all 0.5s ease }
.panel h2 { margin-bottom:0.5rem }
.panel .date { color:#999;font-size:14px;margin-bottom:1.5rem }
.bar-row { display:flex;align-items:center;gap:10px;margin:1.2rem 0;position:relative;z-index:1 }
.party-logo { width:26px;height:26px;object-fit:contain }
.bar { height:26px;border-radius:6px;display:flex;align-items:center;padding-left:8px;font-size:13px;font-weight:600;transition:all 0.3s ease;width:0;animation:none }
.bar.animate { animation:expandBar 0.8s ease-out forwards }
@keyframes expandBar {
  from { width:0; opacity:0 }
  to { opacity:1 }
}
.bar:hover { opacity:0.8 }
.percent { width:100px;text-align:right;font-weight:600 }
.history-section { margin-top:3rem;padding-top:2rem;border-top:1px solid #333 }
.history-section h3 { font-size:16px;margin-bottom:1rem;color:#999 }
.history-row { margin:1.5rem 0;padding:1rem;background:#1e1e1e;border-radius:8px }
.history-date { font-size:13px;color:#999;margin-bottom:0.8rem }
.history-parties { display:grid;grid-template-columns:repeat(auto-fit,minmax(80px,1fr));gap:0.8rem }
.history-party { text-align:center }
.history-party-name { font-size:11px;color:#aaa;margin-bottom:0.2rem }
.history-party-value { font-size:14px;font-weight:600 }
.trend { display:inline-block;margin-left:6px;font-size:11px;font-weight:600 }
.trend.up { color:#4f7a5a }
.trend.down { color:#a33a3a }
.trend.same { color:#666 }
#elections-2026 { max-height:360px;overflow-y:auto;padding-right:8px }
#elections-2026::-webkit-scrollbar { width:8px }
#elections-2026::-webkit-scrollbar-track { background:#121212;border-radius:4px }
#elections-2026::-webkit-scrollbar-thumb { background:#3a3a3a;border-radius:4px }
#elections-2026::-webkit-scrollbar-thumb:hover { background:#4a4a4a }
.election-item { display:flex;align-items:center;gap:12px;margin:1rem 0;padding:0.8rem;background:#2a2a2a;border-radius:8px;position:relative;z-index:1;flex-wrap:wrap }
.election-coat { width:40px;height:40px;object-fit:contain;flex-shrink:0 }
.election-info { flex:1;min-width:0 }
.election-state { font-weight:600;font-size:14px;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis }
.election-type { font-size:12px;color:#999 }
.election-date { font-size:13px;color:#aaa;white-space:normal;flex-shrink:0;width:100%;margin-top:4px }
.seats-btn { background:#4f7fa8;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;margin-top:1rem;transition:all 0.3s ease;position:relative;z-index:1 }
.seats-btn:hover { background:#5a8bb8;transform:translateY(-1px) }
.modal-overlay { display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center }
.modal-overlay.active { display:flex }
.modal-content { background:#1e1e1e;border-radius:16px;width:90%;max-width:1200px;max-height:90vh;overflow:hidden;position:relative;border:2px solid #4f7fa8 }
.modal-header { display:flex;justify-content:space-between;align-items:center;padding:1.5rem;border-bottom:1px solid #333 }
.modal-header h2 { margin:0;font-size:20px }
.close-btn { background:#a33a3a;color:#fff;border:none;padding:8px 16px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s ease }
.close-btn:hover { background:#c44a4a }
.modal-body { display:grid;grid-template-columns:1fr 1fr;gap:2rem;padding:2rem;max-height:calc(90vh - 80px);overflow-y:auto }
.modal-section { background:#2a2a2a;border-radius:12px;padding:1.5rem }
.modal-section h3 { margin:0 0 1rem 0;font-size:16px;color:#4f7fa8 }
.seats-grid { display:flex;flex-wrap:wrap;gap:4px;margin-top:1rem;justify-content:center;align-items:flex-end;position:relative;min-height:300px }
.seat-dot { border-radius:50%;display:inline-block;position:absolute;transition:opacity 0.4s ease }
.parliament-container { width:100%;height:300px;position:relative }
.party-seat-info { display:flex;align-items:center;gap:10px;margin:0.8rem 0;padding:0.5rem;background:#1e1e1e;border-radius:6px }
.party-seat-logo { width:24px;height:24px;object-fit:contain }
.party-seat-name { flex:1;font-size:14px;font-weight:600 }
.party-seat-count { font-size:14px;font-weight:600;color:#4f7fa8 }
.coalition-party { display:flex;align-items:center;gap:10px;padding:0.8rem;background:#1e1e1e;border-radius:8px;margin:0.5rem 0;cursor:pointer;transition:all 0.3s ease;border:2px solid transparent }
.coalition-party:hover { background:#2a2a2a }
.coalition-party.selected { border-color:#4f7a5a;background:#2d2d2d }
.coalition-result { margin-top:1.5rem;padding:1rem;border-radius:8px;text-align:center;font-size:16px;font-weight:600 }
.coalition-result.majority { background:#4f7a5a;color:#fff }
.coalition-result.no-majority { background:#a33a3a;color:#fff }
.coalition-stats { display:flex;justify-content:space-around;margin-top:1rem;padding:1rem;background:#1e1e1e;border-radius:8px }
.coalition-stat { text-align:center }
.coalition-stat-value { font-size:24px;font-weight:600;color:#4f7fa8 }
.coalition-stat-label { font-size:12px;color:#999;margin-top:0.3rem }

/* State Data Modal for Mobile */
.state-modal-overlay { display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#181818;z-index:2000;overflow-y:auto }
.state-modal-overlay.active { display:block }
.state-modal-overlay::before { content:"";position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:400px;height:400px;background-image:var(--bg-coat);background-size:contain;background-repeat:no-repeat;background-position:center;opacity:0.08;pointer-events:none;z-index:0 }
.state-modal-header { display:flex;justify-content:space-between;align-items:center;padding:1.2rem 1rem;border-bottom:1px solid #333;position:sticky;top:0;background:#181818;z-index:10;position:relative }
.state-modal-header h2 { margin:0;font-size:18px;line-height:1.4;position:relative;z-index:1 }
.state-modal-header .close-btn { align-self:center;position:relative;z-index:1 }
.state-modal-body { padding:1.5rem;position:relative;z-index:1 }
.state-modal-body .date { color:#999;font-size:14px;margin-bottom:1.5rem }

/* Mobile Optimizations */
@media screen and (max-width: 1024px) {
  .bundestag-section { padding:0 1rem }
  .bundestag-container { grid-template-columns:1fr !important }
  .main { flex-direction:column;gap:0 }
  .states { width:100%;padding:1rem;grid-template-columns:repeat(3,1fr);gap:1rem }
  .panel { width:100%;padding:1.5rem }
  .modal-body { grid-template-columns:1fr;gap:1rem;padding:1rem }
  .modal-content { width:95%;max-width:none }
}

@media screen and (max-width: 768px) {
  h1 { font-size:24px;padding:0.8rem }
  .bundestag-section { padding:0 0.5rem }
  .bundestag-container { padding:1rem }
  .bundestag-container h2 { font-size:16px }
  .states { grid-template-columns:repeat(2,1fr);gap:0.8rem;padding:0.8rem }
  .state { min-height:120px;padding:0.8rem }
  .state img { width:50px;height:50px }
  .state-name { font-size:12px }
  .panel { padding:1rem }
  .panel h2 { font-size:18px }
  .bar-row { gap:6px;margin:1rem 0 }
  .party-logo { width:22px;height:22px }
  .bar { height:22px;font-size:11px;padding-left:6px }
  .percent { width:70px;font-size:12px }
  .modal-header { padding:1rem }
  .modal-header h2 { font-size:16px }
  .modal-body { padding:0.8rem }
  .modal-section { padding:1rem }
  .seats-grid { min-height:200px }
  .coalition-stat-value { font-size:20px }
  .election-item { gap:8px;padding:0.6rem }
  .election-coat { width:32px;height:32px }
  .election-state { font-size:13px }
  .election-type { font-size:11px }
  .election-date { font-size:12px }
}

@media screen and (max-width: 480px) {
  h1 { font-size:20px;padding:0.5rem }
  .bundestag-section { margin-bottom:1rem }
  .states { grid-template-columns:repeat(2,1fr);gap:0.5rem;padding:0.5rem }
  .state { min-height:100px;padding:0.6rem }
  .state img { width:40px;height:40px }
  .state-name { font-size:11px }
  .panel { padding:0.8rem }
  .panel h2 { font-size:16px }
  .bar-row { margin:0.9rem 0 }
  .bar { height:20px;font-size:10px }
  .party-logo { width:20px;height:20px }
  .percent { width:60px;font-size:11px }
  .history-parties { grid-template-columns:repeat(auto-fit,minmax(60px,1fr)) }
  .modal-header { padding:0.8rem }
  .modal-header h2 { font-size:14px }
  .close-btn { padding:6px 12px;font-size:12px }
  .seats-btn { padding:6px 12px;font-size:11px }
  .coalition-party { padding:0.6rem;gap:8px }
  .party-seat-logo { width:20px;height:20px }
  .party-seat-name { font-size:12px }
  .party-seat-count { font-size:12px }
  .coalition-stat-value { font-size:18px }
  .coalition-stat-label { font-size:11px }
  .election-item { gap:6px;padding:0.6rem }
  .election-coat { width:28px;height:28px }
  .election-state { font-size:12px }
  .election-type { font-size:10px }
  .election-date { font-size:11px }
}

/* Touch-friendly improvements for mobile */
@media (hover: none) and (pointer: coarse) {
  .state { min-height:110px }
  .state:active { background:#2a2a2a;transform:scale(0.98) }
  .coalition-party:active { background:#2a2a2a;transform:scale(0.98) }
  .seats-btn:active { transform:scale(0.95) }
  .close-btn:active { transform:scale(0.95) }
  /* Remove hover effects on mobile */
  .state:hover { transform:none }
  .bar:hover { opacity:1 }
  .seats-btn:hover { transform:none }
  .close-btn:hover { background:#a33a3a }
  .coalition-party:hover { background:#1e1e1e }
}
</style>
</head>
<body>
<div class="modal-overlay" id="seatsModal">
<div class="modal-content">
<div class="modal-header">
<h2 id="modalTitle">Sitzverteilung & Koalitionen</h2>
<button class="close-btn" onclick="closeSeatsModal()">Schließen</button>
</div>
<div class="modal-body">
<div class="modal-section">
<h3>Sitzverteilung</h3>
<div id="seatsList"></div>
<div id="seatsGrid" class="seats-grid"></div>
</div>
<div class="modal-section">
<h3>Koalitionsrechner</h3>
<div id="coalitionParties"></div>
<div class="coalition-stats" id="coalitionStats"></div>
<div class="coalition-result" id="coalitionResult"></div>
</div>
</div>
</div>
</div>
<div class="state-modal-overlay" id="stateModal">
<div class="state-modal-header">
<h2 id="stateModalTitle">Bundesland</h2>
<button class="close-btn" onclick="closeStateModal()">Schließen</button>
</div>
<div class="state-modal-body">
<div class="date" id="stateModalDate"></div>
<div id="stateModalBars"></div>
<div class="history-section">
<h3>Frühere Umfragen</h3>
<div id="stateModalHistory"></div>
</div>
</div>
</div>
<h1>Deutschland Umfragen</h1>
<div class="newest-poll-date" id="newest-poll-info"></div>
<div class="bundestag-section">
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
<div class="bundestag-container">
<h2>Aktuelle Bundestag Umfrage <span id="bundestag-new-badge"></span></h2>
<div class="date" id="bundestag-date"></div>
<div id="bundestag-bars"></div>
<div class="badge-container" id="bundestag-badge"></div>
</div>
<div class="bundestag-container">
<h2>Wahlen 2026</h2>
<div id="elections-2026"></div>
</div>
</div>
</div>
<div class="main">
<div class="states" id="states"></div>
<div class="panel">
<h2 id="title">Bundesland auswählen</h2>
<div class="date" id="date"></div>
<div id="bars"></div>
<div class="history-section">
<h3>Frühere Umfragen</h3>
<div id="history"></div>
</div>
</div>
</div>

<script>
// Handy Detektor
const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
const isTablet = /(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(navigator.userAgent);
const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);

// 
if(isMobile || isTouchDevice) {
  document.body.classList.add('mobile-device');
  
  // 
  if(window.innerWidth < 768) {
    document.body.style.setProperty('--bg-opacity', '0');
  }
  
  // Touch
  document.addEventListener('DOMContentLoaded', function() {
    // Zoom Fix
    const buttons = document.querySelectorAll('button, .state, .coalition-party');
    buttons.forEach(btn => {
      btn.addEventListener('touchend', function(e) {
        e.preventDefault();
        this.click();
      });
    });
  });
}

// Handy Support
function setViewportHeight() {
  let vh = window.innerHeight * 0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
if(isMobile) {
  setViewportHeight();
  window.addEventListener('resize', setViewportHeight);
}

const seatCounts = {
  'Bundestag': 630,
  'Baden-Württemberg': 120,
  'Bayern': 180,
  'Berlin': 130,
  'Brandenburg': 88,
  'Bremen': 87,
  'Hamburg': 121,
  'Hessen': 110,
  'Niedersachsen': 135,
  'Mecklenburg-Vorpommern': 71,
  'Nordrhein-Westfalen': 181,
  'Rheinland-Pfalz': 101,
  'Saarland': 51,
  'Sachsen': 120,
  'Sachsen-Anhalt': 83,
  'Schleswig-Holstein': 69,
  'Thüringen': 88
};

let currentSeatsData = null;
let selectedCoalition = [];

const colors = {
"CSU":"#008AC5","CDU":"#000000","AfD":"#009EE0","BSW":"#5A1F47",
"SPD":"#E3000F","Grüne":"#64A12D","FDP":"#FFED00","Linke":"#E74C8C","FW":"#EE7D00","Sonstige":"#666"
};

const logos = {
"CSU":"https://upload.wikimedia.org/wikipedia/commons/thumb/e/ee/CSU_Logo_since_2016.svg/960px-CSU_Logo_since_2016.svg.png",
"CDU":"https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/CDU_Logo_2023.svg/960px-CDU_Logo_2023.svg.png",
"AfD":"https://upload.wikimedia.org/wikipedia/commons/thumb/b/b1/AfD_Logo_2021.svg/250px-AfD_Logo_2021.svg.png",
"BSW":"https://upload.wikimedia.org/wikipedia/de/thumb/a/ad/B%C3%BCndnis_Sahra_Wagenknecht_2025_logo.svg/250px-B%C3%BCndnis_Sahra_Wagenknecht_2025_logo.svg.png",
"SPD":"https://upload.wikimedia.org/wikipedia/commons/4/4f/Logo_SPD_2019.png",
"Grüne":"https://upload.wikimedia.org/wikipedia/commons/thumb/5/51/B%C3%BCndnis_90_-_Die_Gr%C3%BCnen_Logo_%28transparent%29.svg/250px-B%C3%BCndnis_90_-_Die_Gr%C3%BCnen_Logo_%28transparent%29.svg.png",
"FDP":"https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/Logo_der_Freien_Demokraten.svg/250px-Logo_der_Freien_Demokraten.svg.png",
"Linke":"https://upload.wikimedia.org/wikipedia/commons/thumb/d/d6/Logo_Die_Linke_%282023%29.svg/330px-Logo_Die_Linke_%282023%29.svg.png",
"FW":"https://upload.wikimedia.org/wikipedia/de/thumb/7/7e/FreieW%C3%A4hlerBundesvereinigungLogo.svg/330px-FreieW%C3%A4hlerBundesvereinigungLogo.svg.png",
"Sonstige":"https://upload.wikimedia.org/wikipedia/commons/thumb/4/46/Question_mark_%28black%29.svg/250px-Question_mark_%28black%29.svg.png"
};

const stateCoats = {
"Baden-Württemberg":"https://upload.wikimedia.org/wikipedia/commons/thumb/0/0f/Lesser_coat_of_arms_of_Baden-W%C3%BCrttemberg.svg/960px-Lesser_coat_of_arms_of_Baden-W%C3%BCrttemberg.svg.png",
"Bayern":"https://upload.wikimedia.org/wikipedia/commons/thumb/d/d2/Bayern_Wappen.svg/960px-Bayern_Wappen.svg.png",
"Berlin":"https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/DEU_Berlin_COA.svg/960px-DEU_Berlin_COA.svg.png",
"Brandenburg":"https://upload.wikimedia.org/wikipedia/commons/thumb/a/a2/DEU_Brandenburg_COA.svg/960px-DEU_Brandenburg_COA.svg.png",
"Bremen":"https://upload.wikimedia.org/wikipedia/commons/6/64/Bremen_Wappen%28Mittel%29.svg",
"Hamburg":"https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/DEU_Hamburg_COA.svg/960px-DEU_Hamburg_COA.svg.png",
"Hessen":"https://upload.wikimedia.org/wikipedia/commons/thumb/c/cd/Coat_of_arms_of_Hesse.svg/960px-Coat_of_arms_of_Hesse.svg.png",
"Mecklenburg-Vorpommern":"https://upload.wikimedia.org/wikipedia/commons/thumb/7/74/Coat_of_arms_of_Mecklenburg-Western_Pomerania_%28great%29.svg/960px-Coat_of_arms_of_Mecklenburg-Western_Pomerania_%28great%29.svg.png",
"Niedersachsen":"https://upload.wikimedia.org/wikipedia/commons/thumb/0/01/Wappen_von_Niedersachsen.svg/960px-Wappen_von_Niedersachsen.svg.png",
"Nordrhein-Westfalen":"https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/Coat_of_arms_of_North_Rhine-Westphalia.svg/960px-Coat_of_arms_of_North_Rhine-Westphalia.svg.png",
"Rheinland-Pfalz":"https://upload.wikimedia.org/wikipedia/commons/thumb/8/89/Coat_of_arms_of_Rhineland-Palatinate.svg/960px-Coat_of_arms_of_Rhineland-Palatinate.svg.png",
"Saarland":"https://upload.wikimedia.org/wikipedia/commons/thumb/8/8e/Wappen_des_Saarlands.svg/960px-Wappen_des_Saarlands.svg.png",
"Sachsen":"https://upload.wikimedia.org/wikipedia/commons/thumb/5/5f/Coat_of_arms_of_Saxony.svg/960px-Coat_of_arms_of_Saxony.svg.png",
"Sachsen-Anhalt":"https://upload.wikimedia.org/wikipedia/commons/thumb/5/53/Wappen_Sachsen-Anhalt.svg/960px-Wappen_Sachsen-Anhalt.svg.png",
"Schleswig-Holstein":"https://upload.wikimedia.org/wikipedia/commons/thumb/f/f0/Schleswig-Holstein-Wappen-Drucksache-17-1664.svg/960px-Schleswig-Holstein-Wappen-Drucksache-17-1664.svg.png",
"Thüringen":"https://upload.wikimedia.org/wikipedia/commons/thumb/0/08/Coat_of_arms_of_Thuringia.svg/960px-Coat_of_arms_of_Thuringia.svg.png"
};

// Bundestag
const bundestagData = {
  'date': '13.02.2026',
  'results': {'CDU/CSU': 25.4, 'AfD': 24.4, 'SPD': 15.2, 'Grüne': 12, 'BSW': 3.5, 'FDP': 3.5, 'Linke': 10.4, 'Sonstige': 5.6},
  'history': [
    {'date': '02.02.2026', 'results': {'CDU/CSU': 25.7, 'AfD': 24.6, 'SPD': 15.1, 'Grüne': 12, 'BSW': 3.5, 'FDP': 3.2, 'Linke': 10.2, 'Sonstige': 5.7}}
  ]
};

// CDU/CSU
colors['CDU/CSU'] = '#000000';
logos['CDU/CSU'] = 'https://upload.wikimedia.org/wikipedia/de/thumb/7/7a/CDU-CSU-10.svg/330px-CDU-CSU-10.svg.png?20110122100932';

const data = {
'Baden-Württemberg': {
  'date': '29.01.2026', 
  'results': {'CDU': 29, 'SPD': 10, 'AfD': 20, 'FDP': 5, 'BSW': 3, 'Grüne': 21, 'Linke': 7, 'Sonstige': 5},
  'history': [
    {'date': '22.01.2026', 'results': {'CDU': 29, 'SPD': 8, 'AfD': 20, 'FDP': 5, 'BSW': 0, 'Grüne': 23, 'Linke': 7, 'Sonstige': 8}},
    {'date': '16.10.2025', 'results': {'CDU': 31, 'SPD': 11, 'AfD': 20, 'FDP': 7, 'BSW': 3, 'Grüne': 17, 'Linke': 7, 'Sonstige': 4}},
    {'date': '16.10.2025', 'results': {'CDU': 29, 'SPD': 10, 'AfD': 21, 'FDP': 5, 'BSW': 3, 'Grüne': 20, 'Linke': 7, 'Sonstige': 5}}
  ]
}, 
'Bayern': {
  'date': '19.01.2026', 
  'results': {'CSU': 40, 'SPD': 7, 'AfD': 18, 'FDP': 2, 'BSW': 1, 'Grüne': 12, 'FW': 11, 'Linke': 3, 'Sonstige': 6},
  'history': [
    {'date': '14.01.2026', 'results': {'CSU': 39, 'SPD': 8, 'AfD': 19, 'FDP': 0, 'BSW': 0, 'Grüne': 13, 'FW': 9, 'Linke': 3, 'Sonstige': 9}},
    {'date': '05.01.2026', 'results': {'CSU': 39, 'SPD': 6, 'AfD': 19, 'FDP': 2, 'BSW': 2, 'Grüne': 11, 'FW': 12, 'Linke': 3, 'Sonstige': 6}},
    {'date': '17.12.2025', 'results': {'CSU': 37, 'SPD': 8, 'AfD': 21, 'FDP': 2, 'BSW': 2, 'Grüne': 12, 'FW': 10, 'Linke': 4, 'Sonstige': 4}}
  ]
}, 
'Berlin': {
  'date': '26.01.2026', 
  'results': {'CDU': 22, 'SPD': 15, 'AfD': 16, 'FDP': 3, 'BSW': 3, 'Grüne': 17, 'Linke': 17, 'Sonstige': 7},
  'history': [
    {'date': '16.01.2026', 'results': {'CDU': 22, 'SPD': 14, 'AfD': 17, 'FDP': 0, 'BSW': 3, 'Grüne': 16, 'Linke': 18, 'Sonstige': 10}},
    {'date': '14.01.2026', 'results': {'CDU': 22, 'SPD': 17, 'AfD': 16, 'FDP': 3, 'BSW': 4, 'Grüne': 14, 'Linke': 17, 'Sonstige': 7}},
    {'date': '02.12.2025', 'results': {'CDU': 23, 'SPD': 13, 'AfD': 16, 'FDP': 3, 'BSW': 5, 'Grüne': 15, 'Linke': 18, 'Sonstige': 7}}
  ]
}, 
'Brandenburg': {
  'date': '15.01.2026', 
  'results': {'CDU': 13, 'SPD': 25, 'AfD': 34, 'FDP': 0, 'BSW': 8, 'Grüne': 5, 'Linke': 8, 'Sonstige': 7},
  'history': [
    {'date': '10.12.2025', 'results': {'CDU': 14, 'SPD': 22, 'AfD': 35, 'FDP': 0, 'BSW': 7, 'Grüne': 5, 'Linke': 9, 'Sonstige': 8}},
    {'date': '18.09.2025', 'results': {'CDU': 13, 'SPD': 24, 'AfD': 34, 'FDP': 2, 'BSW': 9, 'Grüne': 4, 'Linke': 9, 'Sonstige': 3}},
    {'date': '25.06.2025', 'results': {'CDU': 14, 'SPD': 23, 'AfD': 32, 'FDP': 0, 'BSW': 9, 'Grüne': 5, 'Linke': 9, 'Sonstige': 8}}
  ]
}, 
'Bremen': {
  'date': '28.04.2025', 
  'results': {'CDU': 22, 'SPD': 25, 'AfD': 15, 'FDP': 0, 'BSW': 0, 'Grüne': 14, 'Linke': 13, 'Sonstige': 11},
  'history': [
    {'date': 'XX.XX.XXXX', 'results': {'CDU': 0, 'SPD': 0, 'AfD': 0, 'FDP': 0, 'BSW': 0, 'Grüne': 0, 'Linke': 0, 'Sonstige': 0}},
    {'date': 'XX.XX.XXXX', 'results': {'CDU': 0, 'SPD': 0, 'AfD': 0, 'FDP': 0, 'BSW': 0, 'Grüne': 0, 'Linke': 0, 'Sonstige': 0}},
    {'date': 'XX.XX.XXXX', 'results': {'CDU': 0, 'SPD': 0, 'AfD': 0, 'FDP': 0, 'BSW': 0, 'Grüne': 0, 'Linke': 0, 'Sonstige': 0}}
  ]
}, 
'Hamburg': {
  'date': '01.03.2025', 
  'results': {'CDU': 18, 'SPD': 33.5, 'AfD': 9, 'FDP': 2.5, 'BSW': 2.5, 'Grüne': 16.5, 'Linke': 14, 'Sonstige': 4},
  'history': [
    {'date': '27.02.2025', 'results': {'CDU': 18, 'SPD': 33, 'AfD': 9, 'FDP': 0, 'BSW': 0, 'Grüne': 17, 'Linke': 12, 'Sonstige': 11}},
    {'date': '27.02.2025', 'results': {'CDU': 17, 'SPD': 32, 'AfD': 11, 'FDP': 3, 'BSW': 3, 'Grüne': 16, 'Linke': 13, 'Sonstige': 5}},
    {'date': '20.02.2025', 'results': {'CDU': 17, 'SPD': 32, 'AfD': 10, 'FDP': 3, 'BSW': 3, 'Grüne': 18, 'Linke': 10, 'Sonstige': 7}}
  ]
}, 
'Hessen': {
  'date': '02.02.2026', 
  'results': {'CDU': 32, 'SPD': 16, 'AfD': 20, 'FDP': 3, 'BSW': 0, 'Grüne': 14, 'Linke': 6, 'Sonstige': 9},
  'history': [
    {'date': '09.10.2025', 'results': {'CDU': 32, 'SPD': 15, 'AfD': 20, 'FDP': 4, 'BSW': 3, 'Grüne': 12, 'Linke': 7, 'Sonstige': 7}},
    {'date': '23.06.2025', 'results': {'CDU': 36, 'SPD': 13, 'AfD': 18, 'FDP': 4, 'BSW': 3, 'Grüne': 14, 'Linke': 6, 'Sonstige': 6}},
    {'date': '25.03.2025', 'results': {'CDU': 31, 'SPD': 14, 'AfD': 19, 'FDP': 3, 'BSW': 5, 'Grüne': 12, 'Linke': 9, 'Sonstige': 7}}
  ]
}, 
'Mecklenburg-Vorpommern': {
  'date': '27.01.2026', 
  'results': {'CDU': 13, 'SPD': 25, 'AfD': 35, 'FDP': 0, 'BSW': 6, 'Grüne': 4, 'Linke': 12, 'Sonstige': 5},
  'history': [
    {'date': '25.09.2025', 'results': {'CDU': 13, 'SPD': 19, 'AfD': 38, 'FDP': 0, 'BSW': 7, 'Grüne': 5, 'Linke': 12, 'Sonstige': 6}},
    {'date': '28.04.2025', 'results': {'CDU': 17, 'SPD': 21, 'AfD': 29, 'FDP': 0, 'BSW': 6, 'Grüne': 5, 'Linke': 15, 'Sonstige': 7}},
    {'date': '07.02.2025', 'results': {'CDU': 16, 'SPD': 21, 'AfD': 29, 'FDP': 3, 'BSW': 9, 'Grüne': 7, 'Linke': 8, 'Sonstige': 7}}
  ]
}, 
'Niedersachsen': {
  'date': '19.11.2025', 
  'results': {'CDU': 26, 'SPD': 26, 'AfD': 20, 'FDP': 3, 'BSW': 3, 'Grüne': 12, 'Linke': 6, 'Sonstige': 4},
  'history': [
    {'date': '19.02.2025', 'results': {'CDU': 30, 'SPD': 25, 'AfD': 16, 'FDP': 5, 'BSW': 5, 'Grüne': 10, 'Linke': 5, 'Sonstige': 4}},
    {'date': '05.12.2024', 'results': {'CDU': 33, 'SPD': 27, 'AfD': 16, 'FDP': 4, 'BSW': 4, 'Grüne': 10, 'Linke': 0, 'Sonstige': 6}},
    {'date': '12.11.2024', 'results': {'CDU': 31, 'SPD': 26, 'AfD': 16, 'FDP': 4, 'BSW': 6, 'Grüne': 10, 'Linke': 2, 'Sonstige': 5}}
  ]
}, 
'Nordrhein-Westfalen': {
  'date': '01.02.2026', 
  'results': {'CDU': 35, 'SPD': 20, 'AfD': 15, 'FDP': 4, 'BSW': 0, 'Grüne': 13, 'Linke': 6, 'Sonstige': 7},
  'history': [
    {'date': '23.11.2025', 'results': {'CDU': 36, 'SPD': 19, 'AfD': 16, 'FDP': 5, 'BSW': 0, 'Grüne': 12, 'Linke': 7, 'Sonstige': 5}},
    {'date': '22.08.2025', 'results': {'CDU': 35, 'SPD': 18, 'AfD': 16, 'FDP': 4, 'BSW': 3, 'Grüne': 13, 'Linke': 8, 'Sonstige': 3}},
    {'date': '09.07.2025', 'results': {'CDU': 38, 'SPD': 17, 'AfD': 16, 'FDP': 3, 'BSW': 2, 'Grüne': 13, 'Linke': 7, 'Sonstige': 4}}
  ]
}, 
'Rheinland-Pfalz': {
  'date': '22.01.2026', 
  'results': {'CDU': 29, 'SPD': 26, 'AfD': 18, 'FDP': 0, 'BSW': 0, 'Grüne': 10, 'Linke': 6, 'Sonstige': 11},
  'history': [
    {'date': '09.10.2025', 'results': {'CDU': 29, 'SPD': 23, 'AfD': 19, 'FDP': 0, 'BSW': 0, 'Grüne': 10, 'Linke': 6, 'Sonstige': 13}},
    {'date': '04.10.2025', 'results': {'CDU': 27, 'SPD': 22, 'AfD': 23, 'FDP': 4, 'BSW': 4, 'Grüne': 9, 'Linke': 6, 'Sonstige': 5}},
    {'date': '20.06.2025', 'results': {'CDU': 28, 'SPD': 24.5, 'AfD': 18, 'FDP': 2, 'BSW': 3, 'Grüne': 10.5, 'Linke': 5.5, 'Sonstige': 8.5}}
  ]
}, 
'Saarland': {
  'date': '03.12.2025', 
  'results': {'CDU': 25, 'SPD': 27, 'AfD': 23, 'FDP': 0, 'BSW': 3, 'Grüne': 7, 'Linke': 7, 'Sonstige': 8},
  'history': [
    {'date': '02.04.2025', 'results': {'CDU': 27, 'SPD': 30, 'AfD': 17, 'FDP': 3, 'BSW': 4, 'Grüne': 6, 'Linke': 8, 'Sonstige': 5}},
    {'date': '26.09.2024', 'results': {'CDU': 31, 'SPD': 29, 'AfD': 14, 'FDP': 0, 'BSW': 10, 'Grüne': 5, 'Linke': 0, 'Sonstige': 11}},
    {'date': '04.05.2024', 'results': {'CDU': 28, 'SPD': 36, 'AfD': 8.5, 'FDP': 3.5, 'BSW': 9, 'Grüne': 5, 'Linke': 2, 'Sonstige': 8}}
  ]
}, 
'Sachsen': {
  'date': '06.01.2026', 
  'results': {'CDU': 29, 'SPD': 6, 'AfD': 35, 'FDP': 1, 'BSW': 8, 'Grüne': 6, 'Linke': 10, 'Sonstige': 5},
  'history': [
    {'date': '04.08.2025', 'results': {'CDU': 27, 'SPD': 6, 'AfD': 35, 'FDP': 1, 'BSW': 9, 'Grüne': 6, 'Linke': 10, 'Sonstige': 6}},
    {'date': '08.07.2025', 'results': {'CDU': 29, 'SPD': 5, 'AfD': 34, 'FDP': 1, 'BSW': 9, 'Grüne': 5, 'Linke': 10, 'Sonstige': 7}},
    {'date': '07.06.2025', 'results': {'CDU': 26, 'SPD': 6, 'AfD': 35, 'FDP': 0, 'BSW': 11, 'Grüne': 5, 'Linke': 9, 'Sonstige': 8}}
  ]
}, 
'Sachsen-Anhalt': {
  'date': '27.01.2026', 
  'results': {'CDU': 26, 'SPD': 8, 'AfD': 39, 'FDP': 2, 'BSW': 6, 'Grüne': 3, 'Linke': 11, 'Sonstige': 5},
  'history': [
    {'date': '15.10.2025', 'results': {'CDU': 26, 'SPD': 6, 'AfD': 40, 'FDP': 3, 'BSW': 6, 'Grüne': 3, 'Linke': 11, 'Sonstige': 5}},
    {'date': '04.09.2025', 'results': {'CDU': 27, 'SPD': 7, 'AfD': 39, 'FDP': 0, 'BSW': 6, 'Grüne': 3, 'Linke': 13, 'Sonstige': 5}},
    {'date': '19.06.2025', 'results': {'CDU': 34, 'SPD': 7, 'AfD': 30, 'FDP': 2, 'BSW': 8, 'Grüne': 3, 'Linke': 11, 'Sonstige': 5}}
  ]
}, 
'Schleswig-Holstein': {
  'date': '22.01.2025', 
  'results': {'CDU': 39, 'SPD': 16, 'AfD': 14, 'FDP': 4, 'BSW': 3, 'Grüne': 13, 'Linke': 0, 'Sonstige': 11},
  'history': [
    {'date': '15.11.2023', 'results': {'CDU': 40, 'SPD': 15, 'AfD': 12, 'FDP': 6, 'BSW': 0, 'Grüne': 16, 'Linke': 0, 'Sonstige': 11}},
    {'date': '02.10.2023', 'results': {'CDU': 32.5, 'SPD': 14, 'AfD': 15, 'FDP': 5, 'BSW': 0, 'Grüne': 18, 'Linke': 1.5, 'Sonstige': 14}},
    {'date': '27.04.2023', 'results': {'CDU': 38, 'SPD': 15, 'AfD': 8, 'FDP': 8, 'BSW': 0, 'Grüne': 17, 'Linke': 0, 'Sonstige': 14}}
  ]
}, 
'Thüringen': {
  'date': '05.02.2026', 
  'results': {'CDU': 24, 'SPD': 7, 'AfD': 38, 'FDP': 0, 'BSW': 7, 'Grüne': 3, 'Linke': 14, 'Sonstige': 7},
  'history': [
    {'date': '11.12.2025', 'results': {'CDU': 24, 'SPD': 6, 'AfD': 39, 'FDP': 0, 'BSW': 7, 'Grüne': 3, 'Linke': 14, 'Sonstige': 7}},
    {'date': '11.09.2025', 'results': {'CDU': 25, 'SPD': 7, 'AfD': 37, 'FDP': 0, 'BSW': 9, 'Grüne': 3, 'Linke': 14, 'Sonstige': 5}},
    {'date': '08.05.2025', 'results': {'CDU': 24, 'SPD': 8, 'AfD': 35, 'FDP': 0, 'BSW': 11, 'Grüne': 3, 'Linke': 14, 'Sonstige': 5}}
  ]
}
};

let currentState = null;

function parseDate(dateStr) {
  // Parse DD.MM.YYYY format
  const parts = dateStr.split('.');
  if(parts.length !== 3 || dateStr.includes('X')) return null;
  return new Date(parts[2], parts[1] - 1, parts[0]);
}

function findNewestPoll() {
  let newestDate = null;
  let newestLocation = null;
  let newestIsBundestag = false;
  
  // Check Bundestag
  const bundestagDate = parseDate(bundestagData.date);
  if(bundestagDate) {
    newestDate = bundestagDate;
    newestLocation = 'Bundestag';
    newestIsBundestag = true;
  }
  
  // Check all Landtag states
  Object.entries(data).forEach(([state, stateData]) => {
    const stateDate = parseDate(stateData.date);
    if(stateDate && (!newestDate || stateDate > newestDate)) {
      newestDate = stateDate;
      newestLocation = state;
      newestIsBundestag = false;
    }
  });
  
  return { 
    date: newestDate, 
    location: newestLocation, 
    isBundestag: newestIsBundestag,
    dateString: formatDate(newestDate)
  };
}

function getLeadingParty(results) {
  let maxPercent = 0;
  let leadingParty = null;
  Object.entries(results).forEach(([party, percent]) => {
    if(percent > maxPercent) {
      maxPercent = percent;
      leadingParty = party;
    }
  });
  return leadingParty;
}

function formatDate(date) {
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}.${month}.${year}`;
}

function buildStates(){
  const newest = findNewestPoll();
  const c=document.getElementById("states");
  
  // Sort states by date (newest first)
  const sortedStates = Object.keys(data).sort((a, b) => {
    const dateA = parseDate(data[a].date);
    const dateB = parseDate(data[b].date);
    return dateB - dateA; // Descending order (newest first)
  });
  
  sortedStates.forEach(s=>{
    const d=document.createElement("div");
    d.className="state";
    
    // Touch/Click detection to prevent opening while scrolling
    let touchStartY = 0;
    let touchEndY = 0;
    let touchStartTime = 0;
    
    d.addEventListener('touchstart', (e) => {
      touchStartY = e.touches[0].clientY;
      touchStartTime = Date.now();
    }, { passive: true });
    
    d.addEventListener('touchend', (e) => {
      touchEndY = e.changedTouches[0].clientY;
      const touchDuration = Date.now() - touchStartTime;
      const touchDistance = Math.abs(touchEndY - touchStartY);
      
      // Only trigger if it was a tap (not a scroll)
      // Max 10px movement and max 300ms duration
      if (touchDistance < 10 && touchDuration < 300) {
        showState(s);
      }
    });
    
    // Desktop click
    d.addEventListener('click', (e) => {
      // Only for non-touch devices
      if (!('ontouchstart' in window)) {
        showState(s);
      }
    });
    
    // Get leading party and set border color
    const leadingParty = getLeadingParty(data[s].results);
    d.style.borderColor = colors[leadingParty] || 'transparent';
    
    // Create content container
    const contentDiv = document.createElement("div");
    contentDiv.className = "state-content";
    
    const img=document.createElement("img");
    img.src=stateCoats[s];
    img.alt=s+" Wappen";
    const name=document.createElement("div");
    name.className="state-name";
    name.textContent=s;
    
    contentDiv.appendChild(img);
    contentDiv.appendChild(name);
    d.appendChild(contentDiv);
    
    // Add "Neue Umfrage" badge at bottom if this has the newest date
    if(data[s].date === newest.dateString) {
      const badgeContainer = document.createElement("div");
      badgeContainer.className = "badge-container";
      const badge = document.createElement("span");
      badge.className = "new-badge";
      badge.textContent = "Neue Umfrage";
      badgeContainer.appendChild(badge);
      d.appendChild(badgeContainer);
    }
    
    c.appendChild(d);
  });
}

function showState(state){
  // Check if mobile (screen width <= 1024px)
  const isMobile = window.innerWidth <= 1024;
  
  if(isMobile) {
    // Mobile: Open modal instead
    openStateModal(state);
    return;
  }
  
  // Desktop: Original behavior
  // Update active state
  if(currentState) {
    const prevStates = document.querySelectorAll('.state');
    prevStates.forEach(s => s.classList.remove('active'));
  }
  currentState = state;
  const states = document.querySelectorAll('.state');
  states.forEach((s) => {
    // Check if this state div's text matches the current state
    const stateName = s.querySelector('.state-name').textContent;
    if(stateName === state) {
      s.classList.add('active');
    }
  });

  // Update background coat of arms
  const panel = document.querySelector('.panel');
  panel.style.setProperty('--bg-coat', `url(${stateCoats[state]})`);

  const bars=document.getElementById("bars");
  bars.innerHTML="";
  document.getElementById("title").innerText=state;
  document.getElementById("date").innerText="Stand: "+data[state].date;
  
  // Calculate trends from most recent history
  const currentResults = data[state].results;
  const previousResults = data[state].history[0].results;
  
  let entries=Object.entries(currentResults).sort((a,b)=>{
    // Always put Sonstige last
    if(a[0] === 'Sonstige') return 1;
    if(b[0] === 'Sonstige') return -1;
    // Sort others by percentage descending
    return b[1]-a[1];
  });
  entries.forEach(([p,v], index)=>{
    const r=document.createElement("div");
    r.className="bar-row";
    
    const logo=document.createElement("img");
    logo.src=logos[p];
    logo.className="party-logo";
    logo.alt=p+" Logo";
    
    const b=document.createElement("div");
    b.className="bar";
    // Responsive scaling based on screen width
    const screenWidth = window.innerWidth;
    let scaleFactor;
    
    if (screenWidth <= 480) {
      // Very small phones: 5px per %
      scaleFactor = 5;
    } else if (screenWidth <= 768) {
      // Small tablets/large phones: 8px per %
      scaleFactor = 8;
    } else {
      // Desktop: 15px per %
      scaleFactor = 15;
    }
    
    // Pure proportional scaling - no minimum to show true differences
    const targetWidth = v > 0 ? (v * scaleFactor) + "px" : "0px";
    b.style.background=colors[p];
    b.style.color = (p==="FDP" ? "#000" : "#fff");
    b.textContent = p;
    
    // Calculate exact percentage difference
    const prevValue = previousResults[p] || 0;
    const diff = v - prevValue;
    let trendText = '';
    let trendClass = 'same';
    
    if(diff > 0) { 
      trendText = '+' + diff.toFixed(1) + '%'; 
      trendClass = 'up'; 
    } else if(diff < 0) { 
      trendText = diff.toFixed(1) + '%'; 
      trendClass = 'down'; 
    } else {
      trendText = '±0%';
    }
    
    // Trigger animation with delay
    setTimeout(() => {
      b.classList.add('animate');
      b.style.width = targetWidth;
    }, index * 100);
    
    const pc=document.createElement("div");
    pc.className="percent";
    pc.innerHTML = v+'% <span class="trend '+trendClass+'">'+trendText+'</span>';
    
    r.appendChild(logo);
    r.appendChild(b);
    r.appendChild(pc);
    bars.appendChild(r);
  });
  
  // Add seats button after bars
  const seatsBtn = document.createElement("button");
  seatsBtn.className = "seats-btn";
  seatsBtn.textContent = "Sitzverteilung/Koalitionen";
  seatsBtn.onclick = () => openSeatsModal(state, currentResults);
  bars.appendChild(seatsBtn);
  
  // Display historical data
  const historyDiv = document.getElementById("history");
  historyDiv.innerHTML = "";
  
  data[state].history.forEach(h => {
    const row = document.createElement("div");
    row.className = "history-row";
    
    const dateDiv = document.createElement("div");
    dateDiv.className = "history-date";
    dateDiv.textContent = h.date;
    row.appendChild(dateDiv);
    
    const partiesDiv = document.createElement("div");
    partiesDiv.className = "history-parties";
    
    // Sort parties by their historical percentages, but always put Sonstige last
    const historicalEntries = Object.entries(h.results).sort((a,b)=>{
      // Always put Sonstige last
      if(a[0] === 'Sonstige') return 1;
      if(b[0] === 'Sonstige') return -1;
      // Sort others by percentage descending
      return b[1]-a[1];
    });
    historicalEntries.forEach(([p, v]) => {
      if(v > 0) {
        const partyDiv = document.createElement("div");
        partyDiv.className = "history-party";
        
        const nameDiv = document.createElement("div");
        nameDiv.className = "history-party-name";
        nameDiv.textContent = p;
        
        const valueDiv = document.createElement("div");
        valueDiv.className = "history-party-value";
        valueDiv.textContent = v + "%";
        
        partyDiv.appendChild(nameDiv);
        partyDiv.appendChild(valueDiv);
        partiesDiv.appendChild(partyDiv);
      }
    });
    
    row.appendChild(partiesDiv);
    historyDiv.appendChild(row);
  });
}

function showBundestag() {
  const newest = findNewestPoll();
  const bars = document.getElementById("bundestag-bars");
  bars.innerHTML = "";
  
  // Set border color based on leading party
  const leadingParty = getLeadingParty(bundestagData.results);
  const bundestagContainer = document.querySelector('.bundestag-container');
  bundestagContainer.style.borderColor = colors[leadingParty] || 'transparent';
  
  // Update date without badge
  document.getElementById("bundestag-date").innerHTML = "Stand: " + bundestagData.date;
  
  // Update badge container if newest
  const badgeContainer = document.getElementById("bundestag-badge");
  badgeContainer.innerHTML = "";
  
  // Show "Neue Umfrage" badge next to title if it's the newest
  const newBadgeContainer = document.getElementById("bundestag-new-badge");
  newBadgeContainer.innerHTML = "";
  if(bundestagData.date === newest.dateString) {
    const badge = document.createElement("span");
    badge.className = "new-badge";
    badge.textContent = "Neue Umfrage";
    newBadgeContainer.appendChild(badge);
  }
  
  // Add seats button
  const seatsBtn = document.createElement("button");
  seatsBtn.className = "seats-btn";
  seatsBtn.textContent = "Sitzverteilung/Koalitionen";
  seatsBtn.onclick = () => openSeatsModal('Bundestag', bundestagData.results);
  badgeContainer.appendChild(seatsBtn);
  
  // Calculate trends from most recent history
  const currentResults = bundestagData.results;
  const previousResults = bundestagData.history[0].results;
  
  let entries = Object.entries(currentResults).sort((a,b) => {
    // Always put Sonstige last
    if(a[0] === 'Sonstige') return 1;
    if(b[0] === 'Sonstige') return -1;
    // Sort others by percentage descending
    return b[1] - a[1];
  });
  entries.forEach(([p, v], index) => {
    const r = document.createElement("div");
    r.className = "bar-row";
    
    const logo = document.createElement("img");
    logo.src = logos[p];
    logo.className = "party-logo";
    logo.alt = p + " Logo";
    
    const b = document.createElement("div");
    b.className = "bar";
    // Responsive scaling based on screen width
    const screenWidth = window.innerWidth;
    let scaleFactor;
    
    if (screenWidth <= 480) {
      // Very small phones: 5px per %
      scaleFactor = 5;
    } else if (screenWidth <= 768) {
      // Small tablets/large phones: 8px per %
      scaleFactor = 8;
    } else {
      // Desktop: 15px per %
      scaleFactor = 15;
    }
    
    // Pure proportional scaling - no minimum to show true differences
    const targetWidth = v > 0 ? (v * scaleFactor) + "px" : "0px";
    b.style.background = colors[p];
    b.style.color = (p === "FDP" ? "#000" : "#fff");
    b.textContent = p;
    
    // Calculate exact percentage difference
    const prevValue = previousResults[p] || 0;
    const diff = v - prevValue;
    let trendText = '';
    let trendClass = 'same';
    
    if(diff > 0) { 
      trendText = '+' + diff.toFixed(1) + '%'; 
      trendClass = 'up'; 
    } else if(diff < 0) { 
      trendText = diff.toFixed(1) + '%'; 
      trendClass = 'down'; 
    } else {
      trendText = '±0%';
    }
    
    // Trigger animation with delay
    setTimeout(() => {
      b.classList.add('animate');
      b.style.width = targetWidth;
    }, index * 100);
    
    const pc = document.createElement("div");
    pc.className = "percent";
    pc.innerHTML = v + '% <span class="trend ' + trendClass + '">' + trendText + '</span>';
    
    r.appendChild(logo);
    r.appendChild(b);
    r.appendChild(pc);
    bars.appendChild(r);
  });
}

// Elections 2026 data
const elections2026 = [
  { state: 'Baden-Württemberg', type: 'Landtag', date: '08.03.2026' },
  { state: 'Bayern', type: 'Kommunalwahl', date: '08.03.2026' },
  { state: 'Hessen', type: 'Kommunalwahl', date: '15.03.2026' },
  { state: 'Rheinland-Pfalz', type: 'Landtag', date: '22.03.2026' },
  { state: 'Sachsen-Anhalt', type: 'Landtag', date: '06.09.2026' },
  { state: 'Niedersachsen', type: 'Kommunalwahl', date: '13.09.2026' },
  { state: 'Berlin', type: 'Abgeordnetenhaus', date: '20.09.2026' },
  { state: 'Mecklenburg-Vorpommern', type: 'Landtag', date: '20.09.2026' }
];

function displayElections() {
  const container = document.getElementById('elections-2026');
  container.innerHTML = '';
  
  elections2026.forEach(election => {
    const item = document.createElement('div');
    item.className = 'election-item';
    
    const coat = document.createElement('img');
    coat.src = stateCoats[election.state];
    coat.className = 'election-coat';
    coat.alt = election.state + ' Wappen';
    
    const info = document.createElement('div');
    info.className = 'election-info';
    
    const stateName = document.createElement('div');
    stateName.className = 'election-state';
    stateName.textContent = election.state;
    
    const electionType = document.createElement('div');
    electionType.className = 'election-type';
    electionType.textContent = election.type;
    
    const electionDate = document.createElement('div');
    electionDate.className = 'election-date';
    electionDate.textContent = election.date;
    
    info.appendChild(stateName);
    info.appendChild(electionType);
    
    item.appendChild(coat);
    item.appendChild(info);
    item.appendChild(electionDate);
    
    container.appendChild(item);
  });
}

buildStates();
showBundestag();
displayElections();

// Display newest poll info at the top
const newest = findNewestPoll();
if(newest.date) {
  const newestInfo = document.getElementById('newest-poll-info');
  newestInfo.textContent = `Neuste Umfrage: ${formatDate(newest.date)} (${newest.location})`;
}

// Show first state by default (which is now the newest after sorting)
// Only on desktop - don't auto-open modal on mobile
const sortedStateKeys = Object.keys(data).sort((a, b) => {
  const dateA = parseDate(data[a].date);
  const dateB = parseDate(data[b].date);
  return dateB - dateA;
});
// Only show state on desktop (avoid auto-opening modal on mobile)
if(window.innerWidth > 1024) {
  showState(sortedStateKeys[0]);
}

// Seat distribution and coalition calculator functions
function calculateSeats(results, totalSeats) {
  // Filter parties: exclude Sonstige and parties below 5%
  const eligibleParties = {};
  
  Object.entries(results).forEach(([party, percent]) => {
    if(party !== 'Sonstige' && percent >= 5) {
      eligibleParties[party] = percent;
    }
  });
  
  // Sainte-Laguë/Schepers method (used in Germany)
  const seats = {};
  Object.keys(eligibleParties).forEach(party => seats[party] = 0);
  
  // Allocate seats one by one
  for(let i = 0; i < totalSeats; i++) {
    let maxQuotient = 0;
    let maxParty = null;
    
    Object.entries(eligibleParties).forEach(([party, percent]) => {
      // Quotient = votes / (2 * seats + 1)
      const quotient = percent / (2 * seats[party] + 1);
      if(quotient > maxQuotient) {
        maxQuotient = quotient;
        maxParty = party;
      }
    });
    
    if(maxParty) {
      seats[maxParty]++;
    }
  }
  
  return seats;
}

function openSeatsModal(location, results) {
  const totalSeats = seatCounts[location] || 630;
  const seats = calculateSeats(results, totalSeats);
  
  currentSeatsData = { location, seats, totalSeats };
  selectedCoalition = [];
  
  document.getElementById('modalTitle').textContent = location + ' - Sitzverteilung & Koalitionen';
  
  // Render seat distribution
  renderSeatDistribution(seats, totalSeats);
  
  // Render coalition calculator
  renderCoalitionCalculator(seats, totalSeats);
  
  document.getElementById('seatsModal').classList.add('active');
}

function closeSeatsModal() {
  document.getElementById('seatsModal').classList.remove('active');
  currentSeatsData = null;
  selectedCoalition = [];
}

function renderSeatDistribution(seats, totalSeats) {
  const listDiv = document.getElementById('seatsList');
  const gridDiv = document.getElementById('seatsGrid');
  
  listDiv.innerHTML = '';
  gridDiv.innerHTML = '';
  
  // Calculate dynamic dot size and spacing based on total seats
  let dotSize = 8;
  let spacing = 1;
  
  // Mobile adjustments
  const screenWidth = window.innerWidth;
  const isMobileView = screenWidth < 768;
  
  if(isMobileView) {
    // Smaller dots on mobile
    if(totalSeats < 100) {
      dotSize = 8;
      spacing = 1.2;
    } else if(totalSeats < 150) {
      dotSize = 6;
      spacing = 1;
    } else if(totalSeats < 200) {
      dotSize = 5;
      spacing = 0.8;
    } else {
      dotSize = 4;
      spacing = 0.8;
    }
  } else {
    // Desktop sizes
    if(totalSeats < 100) {
      dotSize = 12;
      spacing = 1.5;
    } else if(totalSeats < 150) {
      dotSize = 10;
      spacing = 1.5;
    } else if(totalSeats < 200) {
      dotSize = 8;
      spacing = 1.2;
    } else {
      dotSize = 7;
      spacing = 1;
    }
  }
  
  // Political spectrum order: left to right
  // Linke → BSW → Grüne → SPD → FDP → CDU/CSU → AfD
  const politicalOrder = ['Linke', 'BSW', 'Grüne', 'SPD', 'FDP', 'CDU', 'CDU/CSU', 'CSU', 'FW', 'AfD'];
  
  // Sort parties by political spectrum
  const sortedSeats = Object.entries(seats).sort((a, b) => {
    const indexA = politicalOrder.indexOf(a[0]);
    const indexB = politicalOrder.indexOf(b[0]);
    const posA = indexA === -1 ? 999 : indexA;
    const posB = indexB === -1 ? 999 : indexB;
    return posA - posB;
  });
  
  // Render party list (sorted by seat count)
  const sortedByCount = Object.entries(seats).sort((a, b) => b[1] - a[1]);
  sortedByCount.forEach(([party, count]) => {
    const info = document.createElement('div');
    info.className = 'party-seat-info';
    
    const logo = document.createElement('img');
    logo.src = logos[party];
    logo.className = 'party-seat-logo';
    logo.alt = party;
    
    const name = document.createElement('div');
    name.className = 'party-seat-name';
    name.textContent = party;
    
    const countDiv = document.createElement('div');
    countDiv.className = 'party-seat-count';
    countDiv.textContent = count + ' Sitze';
    
    info.appendChild(logo);
    info.appendChild(name);
    info.appendChild(countDiv);
    listDiv.appendChild(info);
  });
  
  // Render parliament semicircle
  // Responsive container size
  const containerWidth = isMobileView ? Math.min(screenWidth - 40, 400) : 560;
  const containerHeight = isMobileView ? Math.min(containerWidth * 0.6, 250) : 300;
  gridDiv.style.width = containerWidth + 'px';
  gridDiv.style.height = containerHeight + 'px';
  gridDiv.style.position = 'relative';
  gridDiv.style.margin = '0 auto';
  
  // Parliament layout parameters - optimized for much tighter spacing
  const numRows = totalSeats < 80 ? 4 : (totalSeats < 120 ? 5 : (totalSeats < 200 ? 6 : 7));
  const baseRadius = totalSeats < 100 ? 40 : (totalSeats < 200 ? 50 : 60);
  const maxRadius = containerWidth / 2 - 20;
  const radiusIncrement = (maxRadius - baseRadius) / Math.max(1, numRows - 1);
  
  // Calculate seats per row based on circumference and dot size
  const seatsPerRow = [];
  let totalCalculated = 0;
  for(let row = 0; row < numRows; row++) {
    const radius = baseRadius + row * radiusIncrement;
    const circumference = Math.PI * radius;
    const seatsInRow = Math.max(3, Math.floor(circumference / (dotSize + spacing)));
    seatsPerRow.push(seatsInRow);
    totalCalculated += seatsInRow;
  }
  
  // Adjust to match exact total seats
  const ratio = totalSeats / totalCalculated;
  for(let i = 0; i < seatsPerRow.length; i++) {
    seatsPerRow[i] = Math.round(seatsPerRow[i] * ratio);
  }
  
  // Fine-tune to exact total
  let currentTotal = seatsPerRow.reduce((a, b) => a + b, 0);
  while(currentTotal < totalSeats) {
    // Add to row with most seats
    const maxRowIndex = seatsPerRow.indexOf(Math.max(...seatsPerRow));
    seatsPerRow[maxRowIndex]++;
    currentTotal++;
  }
  while(currentTotal > totalSeats) {
    // Remove from row with most seats
    const maxRowIndex = seatsPerRow.indexOf(Math.max(...seatsPerRow));
    if(seatsPerRow[maxRowIndex] > 1) {
      seatsPerRow[maxRowIndex]--;
      currentTotal--;
    } else break;
  }
  
  // Create all seat positions first, then assign parties
  const allPositions = [];
  const centerX = containerWidth / 2;
  const centerY = containerHeight - 20;
  
  for(let row = 0; row < numRows; row++) {
    const radius = baseRadius + row * radiusIncrement;
    const seatsInThisRow = seatsPerRow[row];
    
    for(let posInRow = 0; posInRow < seatsInThisRow; posInRow++) {
      const angle = Math.PI * (posInRow / (seatsInThisRow - 1 || 1));
      const x = centerX - radius * Math.cos(angle);
      const y = centerY - radius * Math.sin(angle);
      
      // Calculate horizontal position for sorting (left to right)
      allPositions.push({ x, y, angle, row });
    }
  }
  
  // Sort all positions by angle (left to right in parliament)
  allPositions.sort((a, b) => a.angle - b.angle);
  
  // Assign parties to positions in political order
  let posIndex = 0;
  sortedSeats.forEach(([party, count]) => {
    for(let i = 0; i < count && posIndex < allPositions.length; i++) {
      const pos = allPositions[posIndex];
      
      const dot = document.createElement('div');
      dot.className = 'seat-dot';
      dot.style.width = dotSize + 'px';
      dot.style.height = dotSize + 'px';
      dot.style.background = colors[party];
      dot.style.left = (pos.x - dotSize / 2) + 'px';
      dot.style.top = (pos.y - dotSize / 2) + 'px';
      dot.title = party;
      dot.dataset.party = party;
      
      // Set opacity based on coalition selection
      if(selectedCoalition.length > 0) {
        dot.style.opacity = selectedCoalition.includes(party) ? '1' : '0.15';
      } else {
        dot.style.opacity = '1';
      }
      
      gridDiv.appendChild(dot);
      posIndex++;
    }
  });
}

function renderCoalitionCalculator(seats, totalSeats) {
  const partiesDiv = document.getElementById('coalitionParties');
  partiesDiv.innerHTML = '';
  
  const sortedSeats = Object.entries(seats).sort((a, b) => b[1] - a[1]);
  
  sortedSeats.forEach(([party, count]) => {
    const partyDiv = document.createElement('div');
    partyDiv.className = 'coalition-party';
    partyDiv.onclick = () => toggleCoalitionParty(party);
    
    const logo = document.createElement('img');
    logo.src = logos[party];
    logo.className = 'party-seat-logo';
    logo.alt = party;
    
    const name = document.createElement('div');
    name.className = 'party-seat-name';
    name.textContent = party;
    
    const countDiv = document.createElement('div');
    countDiv.className = 'party-seat-count';
    countDiv.textContent = count + ' Sitze';
    
    partyDiv.appendChild(logo);
    partyDiv.appendChild(name);
    partyDiv.appendChild(countDiv);
    partiesDiv.appendChild(partyDiv);
  });
  
  updateCoalitionResult();
}

function toggleCoalitionParty(party) {
  const index = selectedCoalition.indexOf(party);
  if(index > -1) {
    selectedCoalition.splice(index, 1);
  } else {
    selectedCoalition.push(party);
  }
  
  // Update UI
  const partyDivs = document.querySelectorAll('.coalition-party');
  partyDivs.forEach(div => {
    const partyName = div.querySelector('.party-seat-name').textContent;
    if(selectedCoalition.includes(partyName)) {
      div.classList.add('selected');
    } else {
      div.classList.remove('selected');
    }
  });
  
  updateCoalitionResult();
}

function updateCoalitionResult() {
  if(!currentSeatsData) return;
  
  const { seats, totalSeats } = currentSeatsData;
  const coalitionSeats = selectedCoalition.reduce((sum, party) => sum + (seats[party] || 0), 0);
  const requiredSeats = Math.ceil(totalSeats / 2);
  const hasMajority = coalitionSeats >= requiredSeats;
  
  // Update opacity of existing seat dots without re-rendering
  const allDots = document.querySelectorAll('.seat-dot');
  allDots.forEach(dot => {
    const party = dot.dataset.party;
    if(selectedCoalition.length > 0) {
      dot.style.opacity = selectedCoalition.includes(party) ? '1' : '0.15';
    } else {
      dot.style.opacity = '1';
    }
  });
  
  // Update stats
  const statsDiv = document.getElementById('coalitionStats');
  statsDiv.innerHTML = `
    <div class="coalition-stat">
      <div class="coalition-stat-value">${coalitionSeats}</div>
      <div class="coalition-stat-label">Sitze</div>
    </div>
    <div class="coalition-stat">
      <div class="coalition-stat-value">${requiredSeats}</div>
      <div class="coalition-stat-label">Benötigt</div>
    </div>
    <div class="coalition-stat">
      <div class="coalition-stat-value">${((coalitionSeats / totalSeats) * 100).toFixed(1)}%</div>
      <div class="coalition-stat-label">Anteil</div>
    </div>
  `;
  
  // Update result
  const resultDiv = document.getElementById('coalitionResult');
  if(selectedCoalition.length === 0) {
    resultDiv.innerHTML = 'Wählen Sie Parteien für eine Koalition aus';
    resultDiv.className = 'coalition-result';
  } else if(hasMajority) {
    resultDiv.innerHTML = '✓ Mehrheit erreicht';
    resultDiv.className = 'coalition-result majority';
  } else {
    resultDiv.innerHTML = '✗ Keine Mehrheit';
    resultDiv.className = 'coalition-result no-majority';
  }
}

// Mobile State Modal Functions
function openStateModal(state) {
  const modal = document.getElementById('stateModal');
  const bars = document.getElementById('stateModalBars');
  bars.innerHTML = "";
  
  // Set background coat of arms for the state
  modal.style.setProperty('--bg-coat', `url('${stateCoats[state]}')`);
  
  document.getElementById('stateModalTitle').innerText = state;
  document.getElementById('stateModalDate').innerText = "Stand: " + data[state].date;
  
  // Calculate trends from most recent history
  const currentResults = data[state].results;
  const previousResults = data[state].history[0].results;
  
  let entries = Object.entries(currentResults).sort((a,b) => {
    // Always put Sonstige last
    if(a[0] === 'Sonstige') return 1;
    if(b[0] === 'Sonstige') return -1;
    // Sort others by percentage descending
    return b[1] - a[1];
  });
  
  entries.forEach(([p,v], index) => {
    const r = document.createElement("div");
    r.className = "bar-row";
    
    const logo = document.createElement("img");
    logo.src = logos[p];
    logo.className = "party-logo";
    logo.alt = p + " Logo";
    
    const b = document.createElement("div");
    b.className = "bar";
    // Responsive scaling based on screen width
    const screenWidth = window.innerWidth;
    let scaleFactor;
    
    if (screenWidth <= 480) {
      // Very small phones: 5px per %
      scaleFactor = 5;
    } else if (screenWidth <= 768) {
      // Small tablets/large phones: 8px per %
      scaleFactor = 8;
    } else {
      // Desktop: 15px per %
      scaleFactor = 15;
    }
    
    // Pure proportional scaling - no minimum to show true differences
    const targetWidth = v > 0 ? (v * scaleFactor) + "px" : "0px";
    b.style.background = colors[p];
    b.style.color = (p === "FDP" ? "#000" : "#fff");
    b.textContent = p;
    
    // Calculate exact percentage difference
    const prevValue = previousResults[p] || 0;
    const diff = v - prevValue;
    let trendText = '';
    let trendClass = 'same';
    
    if(diff > 0) { 
      trendText = '+' + diff.toFixed(1) + '%'; 
      trendClass = 'up'; 
    } else if(diff < 0) { 
      trendText = diff.toFixed(1) + '%'; 
      trendClass = 'down'; 
    } else {
      trendText = '±0%';
    }
    
    // Trigger animation with delay
    setTimeout(() => {
      b.classList.add('animate');
      b.style.width = targetWidth;
    }, index * 100);
    
    const pc = document.createElement("div");
    pc.className = "percent";
    pc.innerHTML = v + '% <span class="trend ' + trendClass + '">' + trendText + '</span>';
    
    r.appendChild(logo);
    r.appendChild(b);
    r.appendChild(pc);
    bars.appendChild(r);
  });
  
  // Add seats button after bars
  const seatsBtn = document.createElement("button");
  seatsBtn.className = "seats-btn";
  seatsBtn.textContent = "Sitzverteilung/Koalitionen";
  seatsBtn.onclick = () => {
    closeStateModal();
    openSeatsModal(state, currentResults);
  };
  bars.appendChild(seatsBtn);
  
  // Display historical data
  const historyDiv = document.getElementById("stateModalHistory");
  historyDiv.innerHTML = "";
  
  data[state].history.forEach(h => {
    const row = document.createElement("div");
    row.className = "history-row";
    
    const dateDiv = document.createElement("div");
    dateDiv.className = "history-date";
    dateDiv.textContent = h.date;
    row.appendChild(dateDiv);
    
    const partiesDiv = document.createElement("div");
    partiesDiv.className = "history-parties";
    
    // Sort parties by their historical percentages, but always put Sonstige last
    const historicalEntries = Object.entries(h.results).sort((a,b) => {
      // Always put Sonstige last
      if(a[0] === 'Sonstige') return 1;
      if(b[0] === 'Sonstige') return -1;
      // Sort others by percentage descending
      return b[1] - a[1];
    });
    
    historicalEntries.forEach(([party, percent]) => {
      if(percent > 0) {
        const partyDiv = document.createElement("div");
        partyDiv.className = "history-party";
        
        const nameDiv = document.createElement("div");
        nameDiv.className = "history-party-name";
        nameDiv.textContent = party;
        
        const valueDiv = document.createElement("div");
        valueDiv.className = "history-party-value";
        valueDiv.style.color = colors[party];
        valueDiv.textContent = percent + "%";
        
        partyDiv.appendChild(nameDiv);
        partyDiv.appendChild(valueDiv);
        partiesDiv.appendChild(partyDiv);
      }
    });
    
    row.appendChild(partiesDiv);
    historyDiv.appendChild(row);
  });
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

function closeStateModal() {
  const modal = document.getElementById('stateModal');
  modal.classList.remove('active');
  document.body.style.overflow = '';
}

</script>
</body>
</html>
